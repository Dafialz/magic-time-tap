rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== helpers =====
    function signedIn() { return request.auth != null; }
    function isAdmin() { return signedIn() && request.auth.uid == "zzyUPc53FPOwOSn2DcNZirHyusu1"; }
    function existsDoc() { return resource != null; }

    // —Å—Ç–∞—Ä–∏–π score (0 —è–∫—â–æ –¥–æ–∫–∞ —â–µ –Ω–µ–º–∞)
    function oldScore() {
      return (existsDoc() && (resource.data.score is number)) ? resource.data.score : 0;
    }

    // –û–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ –Ω–∞–∫—Ä—É—Ç–∫—É: –º–∞–∫—Å –ø—Ä–∏—Ä—ñ—Å—Ç –∑–∞ 1 –∑–∞–ø–∏—Å
    function scoreDeltaOk(newScore) {
      return !existsDoc() || (newScore <= oldScore() + 500000);
    }

    // ‚úÖ –∑–∞–±–æ—Ä–æ–Ω—è—î–º–æ –∑–º–µ–Ω—à–µ–Ω–Ω—è score
    function scoreNonDecreasing(newScore) {
      return !existsDoc() || (newScore >= oldScore());
    }

    // ===== balance helpers =====
    function oldBalance() {
      return (existsDoc() && (resource.data.balance is number)) ? resource.data.balance : 0;
    }

    // –õ—ñ–º—ñ—Ç –Ω–∞ —Ä–∞–∑–æ–≤–µ —Å–ø–∏—Å–∞–Ω–Ω—è
    function spendDeltaOk(newBalance) {
      // —è–∫—â–æ –¥–æ–∫ —â–µ –Ω–µ —ñ—Å–Ω—É—î ‚Äî –Ω–µ –¥–∞—î–º–æ "–ø–∏—Å–∞—Ç–∏ balance" (—Ç—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω –º–æ–∂–µ —Å—Ç–∞–≤–∏—Ç–∏)
      return existsDoc()
        && (oldBalance() - newBalance) <= 500000; // <-- –º–æ–∂–µ—à –∑–º—ñ–Ω–∏—Ç–∏ –ª—ñ–º—ñ—Ç
    }

    // ===== leaderboard: —á–∏—Ç–∞—é—Ç—å –≤—Å—ñ, –ø–∏—à–µ —Å–≤—ñ–π –≤–ª–∞—Å–Ω–∏–∫ =====
    match /leaderboard_v1/{userId} {
      allow read: if true;

      // USER –ø–∏—à–µ —Ç—ñ–ª—å–∫–∏ —Å–≤—ñ–π –¥–æ–∫—É–º–µ–Ω—Ç
      allow create, update: if signedIn()
        && request.auth.uid == userId
        && request.resource.data.keys().hasOnly(['name','score','ts'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 64
        && request.resource.data.score is number
        && request.resource.data.score >= 0
        && request.resource.data.score <= 1000000000000000
        && scoreDeltaOk(request.resource.data.score)
        && scoreNonDecreasing(request.resource.data.score);

      // ‚úÖ –ê–¥–º—ñ–Ω –º–æ–∂–µ –ø—Ä–∞–≤–∏—Ç–∏ –±—É–¥—å-—è–∫–∏–π leaderboard score
      allow update: if isAdmin()
        && request.resource.data.keys().hasOnly(['name','score','ts'])
        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 64
        && request.resource.data.score is number
        && request.resource.data.score >= 0
        && request.resource.data.score <= 1000000000000000;

      allow delete: if false;
    }

    // ===== users –ø—Ä–æ—Ñ—ñ–ª—ñ =====
    match /users_v1/{userId} {
      allow read: if true;

      // ---- USER: create —Ç—ñ–ª—å–∫–∏ whitelist –ø–æ–ª—è (–±–µ–∑ balance!) ----
      allow create: if signedIn()
        && request.auth.uid == userId
        && request.resource.data.keys().hasOnly(['name','score','lastSeenAt','tgId','tgUsername','tgFirst','tgLast'])
        && ( !(request.resource.data.score is number)
              || (scoreDeltaOk(request.resource.data.score) && scoreNonDecreasing(request.resource.data.score)) );

      // ---- USER: update –ø—Ä–æ—Ñ—ñ–ª—é —Ç—ñ–ª—å–∫–∏ whitelist –ø–æ–ª—è (–±–µ–∑ balance!) ----
      allow update: if signedIn()
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['name','score','lastSeenAt','tgId','tgUsername','tgFirst','tgLast'])
        && ( !(request.resource.data.score is number)
              || (scoreDeltaOk(request.resource.data.score) && scoreNonDecreasing(request.resource.data.score)) );

      // ‚úÖ USER: –¥–æ–∑–≤–æ–ª—è—î–º–æ –¢–Ü–õ–¨–ö–ò —Å–ø–∏—Å–∞–Ω–Ω—è balance (—Ç—ñ–ª—å–∫–∏ –≤–Ω–∏–∑) + –æ–Ω–æ–≤–ª–µ–Ω–Ω—è balanceUpdatedAt
      allow update: if signedIn()
        && request.auth.uid == userId
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly(['balance','balanceUpdatedAt'])
        && request.resource.data.balance is number
        && request.resource.data.balance >= 0
        && request.resource.data.balance <= oldBalance()   // —Ç—ñ–ª—å–∫–∏ –≤–Ω–∏–∑ –∞–±–æ —Ä—ñ–≤–Ω–æ
        && spendDeltaOk(request.resource.data.balance)
        && request.resource.data.balanceUpdatedAt is timestamp;

      // ---- ADMIN: –±–∞–Ω + –∑–º—ñ–Ω–∞ –±–∞–ª–∞–Ω—Å—É (–≤–≥–æ—Ä—É/–≤–Ω–∏–∑) ----
      allow update: if isAdmin()
        && request.resource.data.diff(resource.data).changedKeys()
          .hasOnly([
            'banned','banReason','bannedAt','bannedBy',
            'balance','balanceReason','balanceUpdatedAt'
          ]);

      allow delete: if false;

      // ===== —ñ–Ω–≤–µ–Ω—Ç–∞—Ä (server-grant only) =====
      // ‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ù–ï –ú–û–ñ–ï –ø–∏—Å–∞—Ç–∏ —ñ–Ω–≤–µ–Ω—Ç–∞—Ä –≤–∑–∞–≥–∞–ª—ñ.
      // ‚úÖ –õ—É—Ç –∑–∞–ø–∏—Å—É—î Cloud Function (Admin SDK) -> rules –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è.
      // (–û–ø—Ü—ñ–π–Ω–æ) –ê–¥–º—ñ–Ω –º–æ–∂–µ –ø—Ä–∞–≤–∏—Ç–∏ –≤—Ä—É—á–Ω—É —á–µ—Ä–µ–∑ –∫–ª—ñ—î–Ω—Ç.
      match /inventory_v1/{itemKey} {
        allow read: if true;

        // üö´ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É - –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ
        // ‚úÖ –∞–¥–º—ñ–Ω–æ–≤—ñ - –º–æ–∂–Ω–∞ (—è–∫—â–æ —Ö–æ—á–µ—à, –º–æ–∂–µ—à —Ç–µ–∂ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ false)
        allow create, update: if isAdmin();
        allow delete: if isAdmin();
      }
    }

    // ===== events/audit =====
    // ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É—é —Ä–æ–±–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–º/–∞–¥–º—ñ–Ω–æ–º, —â–æ–± –Ω–µ –±—É–ª–æ —Å–ø–∞–º—É/–ø—ñ–¥—Ä–æ–±–æ–∫.
    match /events_v1/{id} {
      allow read: if isAdmin();

      // üö´ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É - –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ
      // ‚úÖ –∞–¥–º—ñ–Ω–æ–≤—ñ - –º–æ–∂–Ω–∞
      allow create: if isAdmin();

      allow update, delete: if false;
    }

    // ===== purchase intents (–ø—ñ–¥ TON-–æ–ø–ª–∞—Ç—É) =====
    // –ö–ª—ñ—î–Ω—Ç —Å—Ç–≤–æ—Ä—é—î intent (status="pending") –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ—é.
    // –°–µ—Ä–≤–µ—Ä/Cloud Function (Admin SDK) –ø–æ—Ç—ñ–º –≤–∏—Å—Ç–∞–≤–ª—è—î status="confirmed" —ñ –¥–æ–¥–∞—î txHash/confirmedAt.
    match /purchase_intents_v1/{intentId} {

      // ‚úÖ —á–∏—Ç–∞—Ç–∏ –º–æ–∂–µ –≤–ª–∞—Å–Ω–∏–∫ –∞–±–æ –∞–¥–º—ñ–Ω
      allow read: if isAdmin()
        || (signedIn() && resource.data.userId == request.auth.uid);

      // ‚úÖ create —Ç—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∏–∫, —Ç—ñ–ª—å–∫–∏ expected schema, —ñ —Ç—ñ–ª—å–∫–∏ status="pending"
      allow create: if signedIn()
        && request.resource.data.keys().hasOnly([
          'userId','name','tier','title','priceTon','to','comment',
          'status','createdAt','clientTs'
        ])
        && request.resource.data.userId == request.auth.uid

        && request.resource.data.name is string
        && request.resource.data.name.size() > 0
        && request.resource.data.name.size() <= 64

        && request.resource.data.tier is string
        && request.resource.data.tier in ['blue','purple','gold']

        && request.resource.data.title is string
        && request.resource.data.title.size() > 0
        && request.resource.data.title.size() <= 64

        && request.resource.data.priceTon is number
        && request.resource.data.priceTon in [1,2,3]   // ‚úÖ —Ñ—ñ–∫—Å —Ü—ñ–Ω–∏

        && request.resource.data.to is string
        && request.resource.data.to.size() > 0
        && request.resource.data.to.size() <= 120

        && request.resource.data.comment is string
        && request.resource.data.comment.size() > 0
        && request.resource.data.comment.size() <= 200

        && request.resource.data.status is string
        && request.resource.data.status == 'pending'

        && request.resource.data.createdAt is timestamp
        && request.resource.data.clientTs is number;

      // ‚ùå –∫–ª—ñ—î–Ω—Ç—É update/delete –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ (—â–æ–± –Ω–µ –º—ñ–≥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Å–∞–º)
      // ‚úÖ Cloud Function (Admin SDK) –æ–Ω–æ–≤–∏—Ç—å –Ω–∞–ø—Ä—è–º—É
      allow update, delete: if false;
    }

    // ===== auto-report (cheat_reports_v1) =====
    match /cheat_reports_v1/{id} {
      allow read: if isAdmin();

      allow create: if signedIn()
        && request.resource.data.keys().hasOnly([
          'userId','kind','reason','score','clientTs','at',
          'name','tgId','tgUsername'
        ])
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.kind is string
        && request.resource.data.kind.size() > 0
        && request.resource.data.kind.size() <= 32
        && request.resource.data.reason is string
        && request.resource.data.reason.size() <= 300
        && request.resource.data.score is number
        && request.resource.data.score >= 0
        && request.resource.data.score <= 1000000000000000
        && request.resource.data.clientTs is number;

      allow update, delete: if false;
    }

    // ===== —ñ—Å—Ç–æ—Ä—ñ—è –±–∞–Ω—ñ–≤ =====
    match /ban_history_v1/{id} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // ===== –ª–æ–≥ –¥—ñ–π –∞–¥–º—ñ–Ω–∞ =====
    match /admin_logs_v1/{id} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }
  }
}
